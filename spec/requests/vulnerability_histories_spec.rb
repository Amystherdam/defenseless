require 'rails_helper'

RSpec.describe '/vulnerability_histories', type: :request do
  let(:user) { create(:user) }
  let(:vulnerability) { create(:vulnerability) }

  let(:valid_attributes) do
    {
      status_quo: vulnerability.status,
      vulnerability_creation: vulnerability.created_at,
      vulnerability_id: vulnerability.id,
      user_id: user.id
    }
  end

  let(:valid_headers) do
    user.create_new_auth_token
  end

  describe 'GET /index' do
    it 'renders a successful response' do
      VulnerabilityHistory.create! valid_attributes
      get vulnerability_histories_url, headers: valid_headers, as: :json
      expect(response).to be_successful
    end
  end

  describe 'GET /show' do
    it 'renders a successful response' do
      vulnerability_history = VulnerabilityHistory.create! valid_attributes
      get vulnerability_histories_url(vulnerability_history), headers: valid_headers, as: :json
      expect(response).to be_successful
    end
  end

  describe 'GET /vulnerability' do
    it 'renders a successful response' do
      get "/vulnerability_histories/vulnerability/#{vulnerability.id}", headers: valid_headers, as: :json
      expect(response).to be_successful
    end

    it 'should have creation_date in object' do
      get "/vulnerability_histories/vulnerability/#{vulnerability.id}", headers: valid_headers, as: :json
      response_body = JSON.parse(response.body)
      expect(response_body['data']).to include(Hash)
    end
  end
end
