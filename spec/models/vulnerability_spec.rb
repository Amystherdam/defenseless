require 'rails_helper'

RSpec.describe Vulnerability, type: :model do
  before { create(:vulnerability) }

  describe 'relations' do
    it { is_expected.to(belong_to(:user)) }
  end

  describe 'Enums' do
    it { is_expected.to(define_enum_for(:impact).with_values(%i[low medium high])) }
    it { is_expected.to(define_enum_for(:status).with_values(%i[identified being_analyzed fixed])) }
  end

  describe '#commit' do
    subject { Vulnerability.first }

    it 'when creating must change VulnerabilityHistory in one more' do
      expect { create(:vulnerability) }.to change { VulnerabilityHistory.count }.by(1)
    end

    it 'when updating must change VulnerabilityHistory in one more' do
      vulnerability_params = { status: 2 }
      expect { subject.update(vulnerability_params) }.to change { VulnerabilityHistory.count }.by(1)
    end

    it 'when updating should not change the vulnerability history by more' do
      vulnerability_params = { name: 'Other name' }
      expect { subject.update(vulnerability_params) }.to change { VulnerabilityHistory.count }.by(0)
    end
  end
end
