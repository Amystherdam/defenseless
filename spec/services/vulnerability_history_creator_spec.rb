require 'rails_helper'

RSpec.describe VulnerabilityHistoryCreator do
  before do 
    @vulnerability = create(:vulnerability) 
  end

  let(:creator) { VulnerabilityHistoryCreator.new }

  describe '#create' do
    subject { Vulnerability.first }

    context 'Should change VulnerabilityHistory' do
      it 'Should add one more after creation' do
        expect { creator.create('create', @vulnerability) }.to change { VulnerabilityHistory.count }.by(1)
      end

      it 'Should add one more after updating' do
        vulnerability_params = { status: 2 }
        subject.update(vulnerability_params)

        expect { creator.create('update', subject) }.to change { VulnerabilityHistory.count }.by(1)
      end
    end

    context 'Should not change VulnerabilityHistory' do
      it 'Should not add if status stays the same' do
        vulnerability_params = { name: 'Other name' }
        subject.update(vulnerability_params)

        expect { creator.create('update', subject) }.to change { VulnerabilityHistory.count }.by(0)
      end
    end
  end
end
